name: SnapHaven Dev CI/CD (Build-Transfer-Reload)

on:
  push:
    branches: [develop]

jobs:
  build:
    name: Build NestJS & Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Create Env Files
        run: |
          echo "${{ secrets.SERVER_ENV_DEV }}" > server/.env.dev
          echo "${{ secrets.CLIENT_ENV_DEV }}" > client/.env.dev

      - name: Build Server & Client
        run: |
          cd server && npm install && npm run build
          cd ../client && npm install && npm run build:dev

      - name: Prepare Deployment Artifacts
        run: |
          mkdir -p deploy/server-dist deploy/client-next

          # í´ë” ìì²´ê°€ ì•„ë‹Œ 'ë‚´ìš©ë¬¼(*)'ë§Œ ë³µì‚¬í•˜ì—¬ ì¤‘ì²© ë°©ì§€
          cp -r server/dist/* deploy/server-dist/
          cp server/package*.json deploy/

          # .next ìˆ¨ê¹€ í´ë”ì˜ ë‚´ìš©ë¬¼ì„ ë³µì‚¬
          cp -r client/.next/* deploy/client-next/
          cp client/package*.json deploy/
          cp manage.sh deploy/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: deploy/

  deploy:
    name: Transfer & Reload
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: deploy/

      - name: Transfer Files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "/home/ubuntu/SnapHaven_tmp"
          strip_components: 1

      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ§¹ 1. Git ìƒíƒœ ì´ˆê¸°í™” ë° í´ë” ì •ë¦¬"
            cd /home/ubuntu/SnapHaven
            git reset --hard HEAD
            git clean -fd

            # ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì™„ì „ ì‚­ì œ
            rm -rf server/dist client/.next
            mkdir -p server/dist client/.next

            echo "ğŸšš 2. ìƒˆ íŒŒì¼ ë°°ì¹˜ (ë‚´ìš©ë¬¼ ì§ì ‘ ë³µì‚¬)"
            # tmpì˜ í•˜ìœ„ í´ë” ë‚´ìš©ë¬¼ì„ ëª©ì ì§€ í´ë”ë¡œ ì§ì ‘ ì´ë™
            cp -rf /home/ubuntu/SnapHaven_tmp/server-dist/* /home/ubuntu/SnapHaven/server/dist/
            cp -rf /home/ubuntu/SnapHaven_tmp/client-next/* /home/ubuntu/SnapHaven/client/.next/

            # package.jsonì€ ê° í´ë” ë£¨íŠ¸ë¡œ
            cp -f /home/ubuntu/SnapHaven_tmp/package*.json /home/ubuntu/SnapHaven/server/
            cp -f /home/ubuntu/SnapHaven_tmp/package*.json /home/ubuntu/SnapHaven/client/
            cp -f /home/ubuntu/SnapHaven_tmp/manage.sh /home/ubuntu/SnapHaven/

            echo "ğŸ”‘ 3. í™˜ê²½ ì„¤ì • ë° ê¶Œí•œ ë¶€ì—¬"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20

            chmod +x manage.sh

            echo "ğŸ“¦ 4. ì˜ì¡´ì„± ì„¤ì¹˜"
            # Next.js 15 í™˜ê²½ì—ì„œ TS ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ í•„ìš”í•œ ê²½ìš° --production ì œì™¸ ê³ ë ¤
            (cd server && npm install --production)
            (cd client && npm install --production)

            echo "ğŸ”„ 5. ì„œë¹„ìŠ¤ ë¦¬ë¡œë“œ"
            ./manage.sh reload dev

            echo "âœ¨ ë°˜ì˜ í™•ì¸ (ì„œë²„ ì‹œê°„):"
            ls -l server/dist/main.js

            rm -rf /home/ubuntu/SnapHaven_tmp/*
