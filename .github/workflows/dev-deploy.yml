name: SnapHaven Dev CI/CD (Build-Transfer-Reload)

on:
  push:
    branches: [develop] # develop ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build:
    name: Build NestJS & Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      # 1. ì„œë²„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create Server Env File
        run: |
          echo "${{ secrets.SERVER_ENV_DEV }}" > server/.env.dev

      # 2. í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create Client Env File
        run: |
          echo "${{ secrets.CLIENT_ENV_DEV }}" > client/.env.dev

      # 1. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ (GitHub Runnerì˜ ìì› ì‚¬ìš©)
      - name: Install & Build Server (NestJS)
        run: |
          cd server
          npm install
          npm run build

      - name: Install & Build Client (Next.js)
        run: |
          cd client
          npm install
          npm run build:dev

      # 2. ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë§Œ ë¬¶ê¸° (Artifact ì¤€ë¹„)
      # ë¹Œë“œ ê²°ê³¼ë¬¼(dist, .next)ê³¼ ì„¤ì • íŒŒì¼(package.json, manage.sh)ë§Œ í¬í•¨
      - name: Prepare Deployment Artifacts
        run: |
          mkdir -p deploy
          # í´ë” ìì²´ë¥¼ ë³µì‚¬í•˜ì—¬ êµ¬ì¡°ë¥¼ ë‹¨ìˆœí™” (ì¤‘ì²© ë°©ì§€)
          cp -r server/dist deploy/server-dist
          cp server/package*.json deploy/
          cp -r client/.next deploy/client-next # .next ìˆ¨ê¹€í´ë” í†µì§¸ë¡œ ë³µì‚¬
          cp client/package*.json deploy/
          cp manage.sh deploy/

      # 3. ë¹Œë“œ ê²°ê³¼ë¬¼ ì„ì‹œ ì €ì¥
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: deploy/

  deploy:
    name: Transfer & Reload
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: deploy/

      # 4. EC2ë¡œ íŒŒì¼ ì „ì†¡ (ë³€ê²½ëœ íŒŒì¼ë§Œ íš¨ìœ¨ì ìœ¼ë¡œ ì „ì†¡)
      - name: Transfer Files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "/home/ubuntu/SnapHaven_tmp" # ì„ì‹œ í´ë”ì— ë¨¼ì € ì „ì†¡
          strip_components: 1

      # 5. ì›ê²© ì„œë²„ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ§¹ 1. Git ìƒíƒœ ì´ˆê¸°í™” ë° í´ë” ì •ë¦¬"
            cd /home/ubuntu/SnapHaven
            git reset --hard HEAD
            git clean -fd

            # ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì™„ì „ ì‚­ì œ (ê¹¨ë—í•œ ìƒíƒœì—ì„œ ë³µì‚¬)
            rm -rf server/dist client/.next

            echo "ğŸšš 2. ìƒˆ íŒŒì¼ ë°°ì¹˜ ì‹œì‘"
            cp -rf /home/ubuntu/SnapHaven_tmp/server-dist/* server/dist/
            cp -rf /home/ubuntu/SnapHaven_tmp/client-next/* client/.next/

            cp -f /home/ubuntu/SnapHaven_tmp/package*.json server/
            cp -f /home/ubuntu/SnapHaven_tmp/package*.json client/

            echo "ğŸ”‘ 3. í™˜ê²½ ì„¤ì • ë° ê¶Œí•œ ë¶€ì—¬"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 || echo "NVM use failed, using system node"

            chmod +x manage.sh

            echo "ğŸ“¦ 4. ì˜ì¡´ì„± ì„¤ì¹˜"
            cd server && npm install --production
            cd client && npm install

            echo "ğŸ”„ 5. ì„œë¹„ìŠ¤ ë¦¬ë¡œë“œ"
            pm2 stop all || true
            ./manage.sh reload dev


            echo "âœ¨ ë°˜ì˜ í™•ì¸ (ì„œë²„ ì‹œê°„):"
            ls -l server/dist/main.js

            rm -rf /home/ubuntu/SnapHaven_tmp/*

      # 6. ì—ëŸ¬ ë°œìƒ ì‹œ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
      - name: On Failure Notification
        if: failure()
        run: echo "âŒ ë°°í¬ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
