name: SnapHaven Dev CI/CD (Build-Transfer-Reload)

on:
  push:
    branches: [develop] # develop 브랜치에 푸시될 때 실행

jobs:
  build:
    name: Build NestJS & Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      # 1. 서버 환경 변수 파일 생성
      - name: Create Server Env File
        run: |
          echo "${{ secrets.SERVER_ENV_DEV }}" > server/.env.dev

      # 2. 클라이언트 환경 변수 파일 생성
      - name: Create Client Env File
        run: |
          echo "${{ secrets.CLIENT_ENV_DEV }}" > client/.env.dev

      # 1. 의존성 설치 및 빌드 (GitHub Runner의 자원 사용)
      - name: Install & Build Server (NestJS)
        run: |
          cd server
          npm install
          npm run build

      - name: Install & Build Client (Next.js)
        run: |
          cd client
          npm install
          npm run build:dev

      # 2. 배포에 필요한 파일만 묶기 (Artifact 준비)
      # 빌드 결과물(dist, .next)과 설정 파일(package.json, manage.sh)만 포함
      - name: Prepare Deployment Artifacts
        run: |
          # 필요한 하위 폴더들을 미리 모두 생성
          mkdir -p deploy/server-dist
          mkdir -p deploy/server-pkg
          mkdir -p deploy/client-next
          mkdir -p deploy/client-pkg

          # 각 경로로 파일들을 복사
          cp -r server/dist deploy/server-dist
          cp server/package*.json deploy/server-pkg/
          cp -r client/.next deploy/client-next
          cp client/package*.json deploy/client-pkg/
          cp manage.sh deploy/
          # 서버에서 npm install --production 시 필요함

      # 3. 빌드 결과물 임시 저장
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: deploy/

  deploy:
    name: Transfer & Reload
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: deploy/

      # 4. EC2로 파일 전송 (변경된 파일만 효율적으로 전송)
      - name: Transfer Files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: 22
          source: "deploy/*"
          target: "/home/ubuntu/SnapHaven_tmp" # 임시 폴더에 먼저 전송
          strip_components: 1

      # 5. 원격 서버에서 배포 스크립트 실행
      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            # 파일이 잘 도착했는지 디버깅용 로그 출력
            echo "--- 전송된 파일 목록 확인 ---"
            ls -R /home/ubuntu/SnapHaven_tmp

            # 목적지 폴더 생성
            mkdir -p /home/ubuntu/SnapHaven/server
            mkdir -p /home/ubuntu/SnapHaven/client

            # 빌드 파일 교체
            # 파일이 존재하지 않아도 에러로 중단되지 않게 처리
            cp -rf /home/ubuntu/SnapHaven_tmp/server-dist/* /home/ubuntu/SnapHaven/server/dist/ || echo "Server dist copy failed"
            cp -f /home/ubuntu/SnapHaven_tmp/server-pkg/package*.json /home/ubuntu/SnapHaven/server/ || echo "Server pkg copy failed"
            cp -rf /home/ubuntu/SnapHaven_tmp/client-next/* /home/ubuntu/SnapHaven/client/.next/ || echo "Client next copy failed"
            cp -f /home/ubuntu/SnapHaven_tmp/client-pkg/package*.json /home/ubuntu/SnapHaven/client/ || echo "Client pkg copy failed"
            cp -f /home/ubuntu/SnapHaven_tmp/manage.sh /home/ubuntu/SnapHaven/

            # 배포 스크립트 실행
            cd /home/ubuntu/SnapHaven
            chmod +x manage.sh

            # 의존성 설치 (서버 부하 방지를 위해 production 모드로 필요한 것만)
            cd server && npm install --production
            cd ../client && npm install --production

            # [핵심] 기존에 만든 manage.sh 실행 (무중단 reload)
            cd ..
            ./manage.sh reload dev

      # 6. 에러 발생 시 알림 (선택 사항)
      - name: On Failure Notification
        if: failure()
        run: echo "❌ 배포 중 에러가 발생했습니다. 로그를 확인하세요."
